<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>snapshotter.core_api &mdash; Powerloom Snapshotter 0.1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->

        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=e031e9a9"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
</head>

<body class="wy-body-for-nav">
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >



          <a href="../../index.html">

          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../snapshotter.html">Powerloom Snapshotter</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Powerloom Snapshotter</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">snapshotter.core_api</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">

  <h1>Source code for snapshotter.core_api</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">Depends</span>
<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">Request</span>
<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">fastapi.middleware.cors</span> <span class="kn">import</span> <span class="n">CORSMiddleware</span>
<span class="kn">from</span> <span class="nn">fastapi_pagination</span> <span class="kn">import</span> <span class="n">add_pagination</span>
<span class="kn">from</span> <span class="nn">fastapi_pagination</span> <span class="kn">import</span> <span class="n">Page</span>
<span class="kn">from</span> <span class="nn">fastapi_pagination</span> <span class="kn">import</span> <span class="n">paginate</span>
<span class="kn">from</span> <span class="nn">ipfs_client.main</span> <span class="kn">import</span> <span class="n">AsyncIPFSClientSingleton</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">Field</span>
<span class="kn">from</span> <span class="nn">redis</span> <span class="kn">import</span> <span class="n">asyncio</span> <span class="k">as</span> <span class="n">aioredis</span>
<span class="kn">from</span> <span class="nn">web3</span> <span class="kn">import</span> <span class="n">Web3</span>

<span class="kn">from</span> <span class="nn">snapshotter.auth.helpers.data_models</span> <span class="kn">import</span> <span class="n">RateLimitAuthCheck</span>
<span class="kn">from</span> <span class="nn">snapshotter.auth.helpers.data_models</span> <span class="kn">import</span> <span class="n">UserStatusEnum</span>
<span class="kn">from</span> <span class="nn">snapshotter.auth.helpers.helpers</span> <span class="kn">import</span> <span class="n">incr_success_calls_count</span>
<span class="kn">from</span> <span class="nn">snapshotter.auth.helpers.helpers</span> <span class="kn">import</span> <span class="n">inject_rate_limit_fail_response</span>
<span class="kn">from</span> <span class="nn">snapshotter.auth.helpers.helpers</span> <span class="kn">import</span> <span class="n">rate_limit_auth_check</span>
<span class="kn">from</span> <span class="nn">snapshotter.auth.helpers.redis_conn</span> <span class="kn">import</span> <span class="n">RedisPoolCache</span> <span class="k">as</span> <span class="n">AuthRedisPoolCache</span>
<span class="kn">from</span> <span class="nn">snapshotter.settings.config</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">snapshotter.utils.data_utils</span> <span class="kn">import</span> <span class="n">get_project_epoch_snapshot</span>
<span class="kn">from</span> <span class="nn">snapshotter.utils.data_utils</span> <span class="kn">import</span> <span class="n">get_project_finalized_cid</span>
<span class="kn">from</span> <span class="nn">snapshotter.utils.data_utils</span> <span class="kn">import</span> <span class="n">get_snapshotter_project_status</span>
<span class="kn">from</span> <span class="nn">snapshotter.utils.data_utils</span> <span class="kn">import</span> <span class="n">get_snapshotter_status</span>
<span class="kn">from</span> <span class="nn">snapshotter.utils.default_logger</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">snapshotter.utils.file_utils</span> <span class="kn">import</span> <span class="n">read_json_file</span>
<span class="kn">from</span> <span class="nn">snapshotter.utils.models.data_models</span> <span class="kn">import</span> <span class="n">SnapshotterEpochProcessingReportItem</span>
<span class="kn">from</span> <span class="nn">snapshotter.utils.models.data_models</span> <span class="kn">import</span> <span class="n">SnapshotterStates</span>
<span class="kn">from</span> <span class="nn">snapshotter.utils.models.data_models</span> <span class="kn">import</span> <span class="n">SnapshotterStateUpdate</span>
<span class="kn">from</span> <span class="nn">snapshotter.utils.models.data_models</span> <span class="kn">import</span> <span class="n">TaskStatusRequest</span>
<span class="kn">from</span> <span class="nn">snapshotter.utils.redis.rate_limiter</span> <span class="kn">import</span> <span class="n">load_rate_limiter_scripts</span>
<span class="kn">from</span> <span class="nn">snapshotter.utils.redis.redis_conn</span> <span class="kn">import</span> <span class="n">RedisPoolCache</span>
<span class="kn">from</span> <span class="nn">snapshotter.utils.redis.redis_keys</span> <span class="kn">import</span> <span class="n">active_status_key</span>
<span class="kn">from</span> <span class="nn">snapshotter.utils.redis.redis_keys</span> <span class="kn">import</span> <span class="n">epoch_id_epoch_released_key</span>
<span class="kn">from</span> <span class="nn">snapshotter.utils.redis.redis_keys</span> <span class="kn">import</span> <span class="n">epoch_id_project_to_state_mapping</span>
<span class="kn">from</span> <span class="nn">snapshotter.utils.redis.redis_keys</span> <span class="kn">import</span> <span class="n">epoch_process_report_cached_key</span>
<span class="kn">from</span> <span class="nn">snapshotter.utils.redis.redis_keys</span> <span class="kn">import</span> <span class="n">project_last_finalized_epoch_key</span>
<span class="kn">from</span> <span class="nn">snapshotter.utils.rpc</span> <span class="kn">import</span> <span class="n">RpcHelper</span>


<span class="n">REDIS_CONN_CONF</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
    <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
    <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
    <span class="s1">&#39;db&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">db</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># setup logging</span>
<span class="n">rest_logger</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="s1">&#39;Powerloom|CoreAPI&#39;</span><span class="p">)</span>


<span class="n">protocol_state_contract_abi</span> <span class="o">=</span> <span class="n">read_json_file</span><span class="p">(</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">protocol_state</span><span class="o">.</span><span class="n">abi</span><span class="p">,</span>
    <span class="n">rest_logger</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">protocol_state_contract_address</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">protocol_state</span><span class="o">.</span><span class="n">address</span>

<span class="c1"># setup CORS origins stuff</span>
<span class="n">origins</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<span class="c1"># for pagination of epoch processing status reports</span>
<span class="n">Page</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">with_custom_options</span><span class="p">(</span>
    <span class="n">size</span><span class="o">=</span><span class="n">Field</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">30</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">add_pagination</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
    <span class="n">CORSMiddleware</span><span class="p">,</span>
    <span class="n">allow_origins</span><span class="o">=</span><span class="n">origins</span><span class="p">,</span>
    <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">allow_methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">],</span>
    <span class="n">allow_headers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">],</span>
<span class="p">)</span>


<div class="viewcode-block" id="startup_boilerplate"><a class="viewcode-back" href="../../snapshotter.html#snapshotter.core_api.startup_boilerplate">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s1">&#39;startup&#39;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">startup_boilerplate</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function initializes various state variables and caches required for the application to function properly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">aioredis_pool</span> <span class="o">=</span> <span class="n">RedisPoolCache</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">aioredis_pool</span><span class="o">.</span><span class="n">populate</span><span class="p">()</span>
    <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">redis_pool</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">aioredis_pool</span><span class="o">.</span><span class="n">_aioredis_pool</span>
    <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">auth_aioredis_singleton</span> <span class="o">=</span> <span class="n">AuthRedisPoolCache</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">auth_aioredis_singleton</span><span class="o">.</span><span class="n">populate</span><span class="p">()</span>
    <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">auth_aioredis_pool</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">auth_aioredis_singleton</span><span class="o">.</span><span class="n">_aioredis_pool</span>
    <span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">core_settings</span> <span class="o">=</span> <span class="n">settings</span>
    <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">local_user_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">load_rate_limiter_scripts</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">auth_aioredis_pool</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">anchor_rpc_helper</span> <span class="o">=</span> <span class="n">RpcHelper</span><span class="p">(</span><span class="n">rpc_settings</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">anchor_chain_rpc</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">protocol_state_contract</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">anchor_rpc_helper</span><span class="o">.</span><span class="n">get_current_node</span><span class="p">()[</span><span class="s1">&#39;web3_client&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
        <span class="n">address</span><span class="o">=</span><span class="n">Web3</span><span class="o">.</span><span class="n">toChecksumAddress</span><span class="p">(</span>
            <span class="n">protocol_state_contract_address</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">abi</span><span class="o">=</span><span class="n">protocol_state_contract_abi</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">ipfs_singleton</span> <span class="o">=</span> <span class="n">AsyncIPFSClientSingleton</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">ipfs</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">ipfs_singleton</span><span class="o">.</span><span class="n">init_sessions</span><span class="p">()</span>
    <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">ipfs_reader_client</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">ipfs_singleton</span><span class="o">.</span><span class="n">_ipfs_read_client</span>
    <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">epoch_size</span> <span class="o">=</span> <span class="mi">0</span></div>


<span class="c1"># Health check endpoint</span>
<div class="viewcode-block" id="health_check"><a class="viewcode-back" href="../../snapshotter.html#snapshotter.core_api.health_check">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/health&#39;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">health_check</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Endpoint to check the health of the Snapshotter service.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    request (Request): The incoming request object.</span>
<span class="sd">    response (Response): The outgoing response object.</span>

<span class="sd">    Returns:</span>
<span class="sd">    dict: A dictionary containing the status of the service.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">redis_conn</span><span class="p">:</span> <span class="n">aioredis</span><span class="o">.</span><span class="n">Redis</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">redis_pool</span>
    <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">redis_conn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">active_status_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_</span><span class="p">:</span>
        <span class="n">active_status</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">_</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">active_status</span><span class="p">:</span>
            <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">503</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Snapshotter is not active&#39;</span><span class="p">,</span>
            <span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;OK&#39;</span><span class="p">}</span></div>


<div class="viewcode-block" id="get_current_epoch"><a class="viewcode-back" href="../../snapshotter.html#snapshotter.core_api.get_current_epoch">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/current_epoch&#39;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_current_epoch</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">,</span>
    <span class="n">rate_limit_auth_dep</span><span class="p">:</span> <span class="n">RateLimitAuthCheck</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span>
        <span class="n">rate_limit_auth_check</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the current epoch data from the protocol state contract.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (Request): The incoming request object.</span>
<span class="sd">        response (Response): The outgoing response object.</span>
<span class="sd">        rate_limit_auth_dep (RateLimitAuthCheck, optional): The rate limit authentication check dependency.</span>
<span class="sd">        Defaults to Depends(rate_limit_auth_check,).</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the current epoch data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">rate_limit_passed</span> <span class="ow">and</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">authorized</span> <span class="ow">and</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">UserStatusEnum</span><span class="o">.</span><span class="n">active</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">inject_rate_limit_fail_response</span><span class="p">(</span><span class="n">rate_limit_auth_dep</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="p">[</span><span class="n">current_epoch_data</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">anchor_rpc_helper</span><span class="o">.</span><span class="n">web3_call</span><span class="p">(</span>
            <span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">protocol_state_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">currentEpoch</span><span class="p">()],</span>
            <span class="n">redis_conn</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">redis_pool</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">current_epoch</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;begin&#39;</span><span class="p">:</span> <span class="n">current_epoch_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="n">current_epoch_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;epochId&#39;</span><span class="p">:</span> <span class="n">current_epoch_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="p">}</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">rest_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
            <span class="s1">&#39;Exception in get_current_epoch&#39;</span><span class="p">,</span>
            <span class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Unable to get current epoch, error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">auth_redis_conn</span><span class="p">:</span> <span class="n">aioredis</span><span class="o">.</span><span class="n">Redis</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">auth_aioredis_pool</span>
    <span class="k">await</span> <span class="n">incr_success_calls_count</span><span class="p">(</span><span class="n">auth_redis_conn</span><span class="p">,</span> <span class="n">rate_limit_auth_dep</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">current_epoch</span></div>


<div class="viewcode-block" id="get_epoch_info"><a class="viewcode-back" href="../../snapshotter.html#snapshotter.core_api.get_epoch_info">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/epoch/</span><span class="si">{epoch_id}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_epoch_info</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">,</span>
    <span class="n">epoch_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">rate_limit_auth_dep</span><span class="p">:</span> <span class="n">RateLimitAuthCheck</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span>
        <span class="n">rate_limit_auth_check</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get epoch information for a given epoch ID.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (Request): The incoming request object.</span>
<span class="sd">        response (Response): The outgoing response object.</span>
<span class="sd">        epoch_id (int): The epoch ID for which to retrieve information.</span>
<span class="sd">        rate_limit_auth_dep (RateLimitAuthCheck, optional): The rate limit authentication check dependency. Defaults to rate_limit_auth_check.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing epoch information including timestamp, block number, and epoch end.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">rate_limit_passed</span> <span class="ow">and</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">authorized</span> <span class="ow">and</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">UserStatusEnum</span><span class="o">.</span><span class="n">active</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">inject_rate_limit_fail_response</span><span class="p">(</span><span class="n">rate_limit_auth_dep</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="p">[</span><span class="n">epoch_info_data</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">anchor_rpc_helper</span><span class="o">.</span><span class="n">web3_call</span><span class="p">(</span>
            <span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">protocol_state_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">epochInfo</span><span class="p">(</span><span class="n">epoch_id</span><span class="p">)],</span>
            <span class="n">redis_conn</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">redis_pool</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">epoch_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">epoch_info_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;blocknumber&#39;</span><span class="p">:</span> <span class="n">epoch_info_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;epochEnd&#39;</span><span class="p">:</span> <span class="n">epoch_info_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="p">}</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">rest_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
            <span class="s1">&#39;Exception in get_current_epoch&#39;</span><span class="p">,</span>
            <span class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Unable to get current epoch, error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">auth_redis_conn</span><span class="p">:</span> <span class="n">aioredis</span><span class="o">.</span><span class="n">Redis</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">auth_aioredis_pool</span>
    <span class="k">await</span> <span class="n">incr_success_calls_count</span><span class="p">(</span><span class="n">auth_redis_conn</span><span class="p">,</span> <span class="n">rate_limit_auth_dep</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">epoch_info</span></div>


<div class="viewcode-block" id="get_project_last_finalized_epoch_info"><a class="viewcode-back" href="../../snapshotter.html#snapshotter.core_api.get_project_last_finalized_epoch_info">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/last_finalized_epoch/</span><span class="si">{project_id}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_project_last_finalized_epoch_info</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">,</span>
    <span class="n">project_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">rate_limit_auth_dep</span><span class="p">:</span> <span class="n">RateLimitAuthCheck</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span>
        <span class="n">rate_limit_auth_check</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the last finalized epoch information for a given project.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (Request): The incoming request object.</span>
<span class="sd">        response (Response): The outgoing response object.</span>
<span class="sd">        project_id (str): The ID of the project to get the last finalized epoch information for.</span>
<span class="sd">        rate_limit_auth_dep (RateLimitAuthCheck, optional): The rate limit authentication dependency. Defaults to rate_limit_auth_check.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the last finalized epoch information for the given project.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">rate_limit_passed</span> <span class="ow">and</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">authorized</span> <span class="ow">and</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">UserStatusEnum</span><span class="o">.</span><span class="n">active</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">inject_rate_limit_fail_response</span><span class="p">(</span><span class="n">rate_limit_auth_dep</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>

        <span class="c1"># get project last finalized epoch from redis</span>
        <span class="n">project_last_finalized_epoch</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">redis_pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">project_last_finalized_epoch_key</span><span class="p">(</span><span class="n">project_id</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">project_last_finalized_epoch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># find from contract</span>
            <span class="n">epoch_finalized</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="p">[</span><span class="n">cur_epoch</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">anchor_rpc_helper</span><span class="o">.</span><span class="n">web3_call</span><span class="p">(</span>
                <span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">protocol_state_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">currentEpoch</span><span class="p">()],</span>
                <span class="n">redis_conn</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">redis_pool</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">epoch_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cur_epoch</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">epoch_finalized</span> <span class="ow">and</span> <span class="n">epoch_id</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># get finalization status</span>
                <span class="p">[</span><span class="n">epoch_finalized_contract</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">anchor_rpc_helper</span><span class="o">.</span><span class="n">web3_call</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">protocol_state_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">snapshotStatus</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">epoch_id</span><span class="p">)],</span>
                    <span class="n">redis_conn</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">redis_pool</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">epoch_finalized_contract</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">epoch_finalized</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">project_last_finalized_epoch</span> <span class="o">=</span> <span class="n">epoch_id</span>
                    <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">redis_pool</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                        <span class="n">project_last_finalized_epoch_key</span><span class="p">(</span><span class="n">project_id</span><span class="p">),</span>
                        <span class="n">project_last_finalized_epoch</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">epoch_id</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">epoch_id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">404</span>
                        <span class="k">return</span> <span class="p">{</span>
                            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Unable to find last finalized epoch for project </span><span class="si">{</span><span class="n">project_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">project_last_finalized_epoch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">project_last_finalized_epoch</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="p">[</span><span class="n">epoch_info_data</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">anchor_rpc_helper</span><span class="o">.</span><span class="n">web3_call</span><span class="p">(</span>
            <span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">protocol_state_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">epochInfo</span><span class="p">(</span><span class="n">project_last_finalized_epoch</span><span class="p">)],</span>
            <span class="n">redis_conn</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">redis_pool</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">epoch_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;epochId&#39;</span><span class="p">:</span> <span class="n">project_last_finalized_epoch</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">epoch_info_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;blocknumber&#39;</span><span class="p">:</span> <span class="n">epoch_info_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;epochEnd&#39;</span><span class="p">:</span> <span class="n">epoch_info_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="p">}</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">rest_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
            <span class="s1">&#39;Exception in get_project_last_finalized_epoch_info&#39;</span><span class="p">,</span>
            <span class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Unable to get last finalized epoch for project </span><span class="si">{</span><span class="n">project_id</span><span class="si">}</span><span class="s1">, error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">auth_redis_conn</span><span class="p">:</span> <span class="n">aioredis</span><span class="o">.</span><span class="n">Redis</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">auth_aioredis_pool</span>
    <span class="k">await</span> <span class="n">incr_success_calls_count</span><span class="p">(</span><span class="n">auth_redis_conn</span><span class="p">,</span> <span class="n">rate_limit_auth_dep</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">epoch_info</span></div>


<span class="c1"># get data for epoch_id, project_id</span>
<div class="viewcode-block" id="get_data_for_project_id_epoch_id"><a class="viewcode-back" href="../../snapshotter.html#snapshotter.core_api.get_data_for_project_id_epoch_id">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/data/</span><span class="si">{epoch_id}</span><span class="s1">/</span><span class="si">{project_id}</span><span class="s1">/&#39;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_data_for_project_id_epoch_id</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">,</span>
    <span class="n">project_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">epoch_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">rate_limit_auth_dep</span><span class="p">:</span> <span class="n">RateLimitAuthCheck</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span>
        <span class="n">rate_limit_auth_check</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get data for a given project and epoch ID.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (Request): The incoming request.</span>
<span class="sd">        response (Response): The outgoing response.</span>
<span class="sd">        project_id (str): The ID of the project.</span>
<span class="sd">        epoch_id (int): The ID of the epoch.</span>
<span class="sd">        rate_limit_auth_dep (RateLimitAuthCheck, optional): The rate limit authentication check. Defaults to Depends(rate_limit_auth_check).</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The data for the given project and epoch ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">rate_limit_passed</span> <span class="ow">and</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">authorized</span> <span class="ow">and</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">UserStatusEnum</span><span class="o">.</span><span class="n">active</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">inject_rate_limit_fail_response</span><span class="p">(</span><span class="n">rate_limit_auth_dep</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_project_epoch_snapshot</span><span class="p">(</span>
            <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">redis_pool</span><span class="p">,</span>
            <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">protocol_state_contract</span><span class="p">,</span>
            <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">anchor_rpc_helper</span><span class="p">,</span>
            <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">ipfs_reader_client</span><span class="p">,</span>
            <span class="n">epoch_id</span><span class="p">,</span>
            <span class="n">project_id</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">rest_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
            <span class="s1">&#39;Exception in get_data_for_project_id_epoch_id&#39;</span><span class="p">,</span>
            <span class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Unable to get data for project_id: </span><span class="si">{</span><span class="n">project_id</span><span class="si">}</span><span class="s1">,&#39;</span>
            <span class="sa">f</span><span class="s1">&#39; epoch_id: </span><span class="si">{</span><span class="n">epoch_id</span><span class="si">}</span><span class="s1">, error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">404</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;No data found for project_id: </span><span class="si">{</span><span class="n">project_id</span><span class="si">}</span><span class="s1">,&#39;</span>
            <span class="sa">f</span><span class="s1">&#39; epoch_id: </span><span class="si">{</span><span class="n">epoch_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="n">auth_redis_conn</span><span class="p">:</span> <span class="n">aioredis</span><span class="o">.</span><span class="n">Redis</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">auth_aioredis_pool</span>
    <span class="k">await</span> <span class="n">incr_success_calls_count</span><span class="p">(</span><span class="n">auth_redis_conn</span><span class="p">,</span> <span class="n">rate_limit_auth_dep</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span></div>


<span class="c1"># get finalized cid for epoch_id, project_id</span>
<div class="viewcode-block" id="get_finalized_cid_for_project_id_epoch_id"><a class="viewcode-back" href="../../snapshotter.html#snapshotter.core_api.get_finalized_cid_for_project_id_epoch_id">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/cid/</span><span class="si">{epoch_id}</span><span class="s1">/</span><span class="si">{project_id}</span><span class="s1">/&#39;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_finalized_cid_for_project_id_epoch_id</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">,</span>
    <span class="n">project_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">epoch_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">rate_limit_auth_dep</span><span class="p">:</span> <span class="n">RateLimitAuthCheck</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span>
        <span class="n">rate_limit_auth_check</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get finalized cid for a given project_id and epoch_id.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (Request): The incoming request.</span>
<span class="sd">        response (Response): The outgoing response.</span>
<span class="sd">        project_id (str): The project id.</span>
<span class="sd">        epoch_id (int): The epoch id.</span>
<span class="sd">        rate_limit_auth_dep (RateLimitAuthCheck, optional): The rate limit auth check dependency. Defaults to rate_limit_auth_check.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The finalized cid for the given project_id and epoch_id.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">rate_limit_passed</span> <span class="ow">and</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">authorized</span> <span class="ow">and</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">UserStatusEnum</span><span class="o">.</span><span class="n">active</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">inject_rate_limit_fail_response</span><span class="p">(</span><span class="n">rate_limit_auth_dep</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_project_finalized_cid</span><span class="p">(</span>
            <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">redis_pool</span><span class="p">,</span>
            <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">protocol_state_contract</span><span class="p">,</span>
            <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">anchor_rpc_helper</span><span class="p">,</span>
            <span class="n">epoch_id</span><span class="p">,</span>
            <span class="n">project_id</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">rest_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
            <span class="s1">&#39;Exception in get_finalized_cid_for_project_id_epoch_id&#39;</span><span class="p">,</span>
            <span class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Unable to get finalized cid for project_id: </span><span class="si">{</span><span class="n">project_id</span><span class="si">}</span><span class="s1">,&#39;</span>
            <span class="sa">f</span><span class="s1">&#39; epoch_id: </span><span class="si">{</span><span class="n">epoch_id</span><span class="si">}</span><span class="s1">, error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">404</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;No finalized cid found for project_id: </span><span class="si">{</span><span class="n">project_id</span><span class="si">}</span><span class="s1">,&#39;</span>
            <span class="sa">f</span><span class="s1">&#39; epoch_id: </span><span class="si">{</span><span class="n">epoch_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="n">auth_redis_conn</span><span class="p">:</span> <span class="n">aioredis</span><span class="o">.</span><span class="n">Redis</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">auth_aioredis_pool</span>
    <span class="k">await</span> <span class="n">incr_success_calls_count</span><span class="p">(</span><span class="n">auth_redis_conn</span><span class="p">,</span> <span class="n">rate_limit_auth_dep</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="get_snapshotter_overall_status"><a class="viewcode-back" href="../../snapshotter.html#snapshotter.core_api.get_snapshotter_overall_status">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/internal/snapshotter/status&#39;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_snapshotter_overall_status</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">,</span>
    <span class="n">rate_limit_auth_dep</span><span class="p">:</span> <span class="n">RateLimitAuthCheck</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span>
        <span class="n">rate_limit_auth_check</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the overall status of the snapshotter.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (Request): The incoming request.</span>
<span class="sd">        response (Response): The outgoing response.</span>
<span class="sd">        rate_limit_auth_dep (RateLimitAuthCheck, optional): The rate limit authentication check. Defaults to Depends(rate_limit_auth_check).</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the snapshotter status.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">rate_limit_passed</span> <span class="ow">and</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">authorized</span> <span class="ow">and</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">UserStatusEnum</span><span class="o">.</span><span class="n">active</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">inject_rate_limit_fail_response</span><span class="p">(</span><span class="n">rate_limit_auth_dep</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">snapshotter_status</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_snapshotter_status</span><span class="p">(</span>
            <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">redis_pool</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">rest_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
            <span class="s1">&#39;Exception in get_snapshotter_overall_status&#39;</span><span class="p">,</span>
            <span class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Unable to get snapshotter status, error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">auth_redis_conn</span><span class="p">:</span> <span class="n">aioredis</span><span class="o">.</span><span class="n">Redis</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">auth_aioredis_pool</span>
    <span class="k">await</span> <span class="n">incr_success_calls_count</span><span class="p">(</span><span class="n">auth_redis_conn</span><span class="p">,</span> <span class="n">rate_limit_auth_dep</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">snapshotter_status</span></div>


<div class="viewcode-block" id="get_snapshotter_project_level_status"><a class="viewcode-back" href="../../snapshotter.html#snapshotter.core_api.get_snapshotter_project_level_status">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/internal/snapshotter/status/</span><span class="si">{project_id}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_snapshotter_project_level_status</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">,</span>
    <span class="n">project_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">rate_limit_auth_dep</span><span class="p">:</span> <span class="n">RateLimitAuthCheck</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span>
        <span class="n">rate_limit_auth_check</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get snapshotter project level status.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (Request): The request object.</span>
<span class="sd">        response (Response): The response object.</span>
<span class="sd">        project_id (str): The project ID.</span>
<span class="sd">        data (bool, optional): Whether to include data in the response. Defaults to False.</span>
<span class="sd">        rate_limit_auth_dep (RateLimitAuthCheck, optional): The rate limit auth check dependency. Defaults to rate_limit_auth_check.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The snapshotter project status.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">rate_limit_passed</span> <span class="ow">and</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">authorized</span> <span class="ow">and</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">UserStatusEnum</span><span class="o">.</span><span class="n">active</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">inject_rate_limit_fail_response</span><span class="p">(</span><span class="n">rate_limit_auth_dep</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">snapshotter_project_status</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_snapshotter_project_status</span><span class="p">(</span>
            <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">redis_pool</span><span class="p">,</span>
            <span class="n">project_id</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span>
            <span class="n">with_data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">rest_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
            <span class="s1">&#39;Exception in get_snapshotter_project_level_status&#39;</span><span class="p">,</span>
            <span class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Unable to get snapshotter status for project_id: </span><span class="si">{</span><span class="n">project_id</span><span class="si">}</span><span class="s1">, error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">snapshotter_project_status</span><span class="p">:</span>
        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">404</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;No snapshotter status found for project_id: </span><span class="si">{</span><span class="n">project_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">auth_redis_conn</span><span class="p">:</span> <span class="n">aioredis</span><span class="o">.</span><span class="n">Redis</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">auth_aioredis_pool</span>
    <span class="k">await</span> <span class="n">incr_success_calls_count</span><span class="p">(</span><span class="n">auth_redis_conn</span><span class="p">,</span> <span class="n">rate_limit_auth_dep</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">snapshotter_project_status</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="n">exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_snapshotter_epoch_processing_status"><a class="viewcode-back" href="../../snapshotter.html#snapshotter.core_api.get_snapshotter_epoch_processing_status">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/internal/snapshotter/epochProcessingStatus&#39;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_snapshotter_epoch_processing_status</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">,</span>
    <span class="n">rate_limit_auth_dep</span><span class="p">:</span> <span class="n">RateLimitAuthCheck</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span>
        <span class="n">rate_limit_auth_check</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Page</span><span class="p">[</span><span class="n">SnapshotterEpochProcessingReportItem</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Endpoint to get the epoch processing status report.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (Request): The incoming request object.</span>
<span class="sd">        response (Response): The outgoing response object.</span>
<span class="sd">        rate_limit_auth_dep (RateLimitAuthCheck, optional): The rate limit authentication check dependency. Defaults to Depends(rate_limit_auth_check).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Page[SnapshotterEpochProcessingReportItem]: The paginated epoch processing status report.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">rate_limit_passed</span> <span class="ow">and</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">authorized</span> <span class="ow">and</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">UserStatusEnum</span><span class="o">.</span><span class="n">active</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">inject_rate_limit_fail_response</span><span class="p">(</span><span class="n">rate_limit_auth_dep</span><span class="p">)</span>
    <span class="n">redis_conn</span><span class="p">:</span> <span class="n">aioredis</span><span class="o">.</span><span class="n">Redis</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">redis_pool</span>
    <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">redis_conn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">epoch_process_report_cached_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_</span><span class="p">:</span>
        <span class="n">epoch_processing_final_report</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">SnapshotterEpochProcessingReportItem</span><span class="o">.</span><span class="n">parse_obj</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">_</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">paginate</span><span class="p">(</span><span class="n">epoch_processing_final_report</span><span class="p">)</span>
    <span class="n">epoch_processing_final_report</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SnapshotterEpochProcessingReportItem</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="p">[</span><span class="n">current_epoch_data</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">anchor_rpc_helper</span><span class="o">.</span><span class="n">web3_call</span><span class="p">(</span>
            <span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">protocol_state_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">currentEpoch</span><span class="p">()],</span>
            <span class="n">redis_conn</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">redis_pool</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">current_epoch</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;begin&#39;</span><span class="p">:</span> <span class="n">current_epoch_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="n">current_epoch_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;epochId&#39;</span><span class="p">:</span> <span class="n">current_epoch_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="p">}</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">rest_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
            <span class="s1">&#39;Exception in get_current_epoch&#39;</span><span class="p">,</span>
            <span class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Unable to get current epoch, error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="n">current_epoch_id</span> <span class="o">=</span> <span class="n">current_epoch</span><span class="p">[</span><span class="s1">&#39;epochId&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">epoch_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="p">[</span><span class="n">epoch_size</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">anchor_rpc_helper</span><span class="o">.</span><span class="n">web3_call</span><span class="p">(</span>
            <span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">protocol_state_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">EPOCH_SIZE</span><span class="p">()],</span>
            <span class="n">redis_conn</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">redis_pool</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">rest_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Setting Epoch size: </span><span class="si">{</span><span class="n">epoch_size</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">epoch_size</span> <span class="o">=</span> <span class="n">epoch_size</span>
    <span class="k">for</span> <span class="n">epoch_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">current_epoch_id</span><span class="p">,</span> <span class="n">current_epoch_id</span> <span class="o">-</span> <span class="mi">30</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">epoch_specific_report</span> <span class="o">=</span> <span class="n">SnapshotterEpochProcessingReportItem</span><span class="o">.</span><span class="n">construct</span><span class="p">()</span>
        <span class="n">epoch_release_status</span> <span class="o">=</span> <span class="k">await</span> <span class="n">redis_conn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">epoch_id_epoch_released_key</span><span class="p">(</span><span class="n">epoch_id</span><span class="o">=</span><span class="n">epoch_id</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">epoch_release_status</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">epoch_specific_report</span><span class="o">.</span><span class="n">epochId</span> <span class="o">=</span> <span class="n">epoch_id</span>
        <span class="k">if</span> <span class="n">epoch_id</span> <span class="o">==</span> <span class="n">current_epoch_id</span><span class="p">:</span>
            <span class="n">epoch_specific_report</span><span class="o">.</span><span class="n">epochEnd</span> <span class="o">=</span> <span class="n">current_epoch</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">epoch_specific_report</span><span class="o">.</span><span class="n">epochEnd</span> <span class="o">=</span> <span class="n">current_epoch</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">current_epoch_id</span> <span class="o">-</span> <span class="n">epoch_id</span><span class="p">)</span> <span class="o">*</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">epoch_size</span>
            <span class="p">)</span>
            <span class="n">rest_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Epoch End for epoch_id: </span><span class="si">{</span><span class="n">epoch_id</span><span class="si">}</span><span class="s1"> is </span><span class="si">{</span><span class="n">epoch_specific_report</span><span class="o">.</span><span class="n">epochEnd</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">epoch_specific_report</span><span class="o">.</span><span class="n">transitionStatus</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">epoch_release_status</span><span class="p">:</span>
            <span class="n">epoch_specific_report</span><span class="o">.</span><span class="n">transitionStatus</span><span class="p">[</span><span class="s1">&#39;EPOCH_RELEASED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SnapshotterStateUpdate</span><span class="p">(</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">epoch_release_status</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">epoch_specific_report</span><span class="o">.</span><span class="n">transitionStatus</span><span class="p">[</span><span class="s1">&#39;EPOCH_RELEASED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">SnapshotterStates</span><span class="p">:</span>
            <span class="n">state_report_entries</span> <span class="o">=</span> <span class="k">await</span> <span class="n">redis_conn</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">epoch_id_project_to_state_mapping</span><span class="p">(</span><span class="n">epoch_id</span><span class="o">=</span><span class="n">epoch_id</span><span class="p">,</span> <span class="n">state_id</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">state_report_entries</span><span class="p">:</span>
                <span class="n">project_state_report_entries</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">epoch_specific_report</span><span class="o">.</span><span class="n">transitionStatus</span><span class="p">[</span><span class="n">state</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">project_state_report_entries</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">project_id</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">):</span> <span class="n">SnapshotterStateUpdate</span><span class="o">.</span><span class="n">parse_raw</span><span class="p">(</span><span class="n">project_state_entry</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">project_state_entry</span> <span class="ow">in</span> <span class="n">state_report_entries</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">epoch_specific_report</span><span class="o">.</span><span class="n">transitionStatus</span><span class="p">[</span><span class="n">state</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">project_state_report_entries</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">epoch_specific_report</span><span class="o">.</span><span class="n">transitionStatus</span><span class="p">[</span><span class="n">state</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">epoch_processing_final_report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_specific_report</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">redis_conn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
        <span class="n">epoch_process_report_cached_key</span><span class="p">,</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span> <span class="n">epoch_processing_final_report</span><span class="p">))),</span>
        <span class="n">ex</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">paginate</span><span class="p">(</span><span class="n">epoch_processing_final_report</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_task_status_post"><a class="viewcode-back" href="../../snapshotter.html#snapshotter.core_api.get_task_status_post">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/task_status&#39;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_task_status_post</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">,</span>
    <span class="n">task_status_request</span><span class="p">:</span> <span class="n">TaskStatusRequest</span><span class="p">,</span>
    <span class="n">rate_limit_auth_dep</span><span class="p">:</span> <span class="n">RateLimitAuthCheck</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span>
        <span class="n">rate_limit_auth_check</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Endpoint to get the status of a task for a given wallet address.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (Request): The incoming request object.</span>
<span class="sd">        response (Response): The outgoing response object.</span>
<span class="sd">        task_status_request (TaskStatusRequest): The request body containing the task type and wallet address.</span>
<span class="sd">        rate_limit_auth_dep (RateLimitAuthCheck, optional): The rate limit and authorization dependency. Defaults to rate_limit_auth_check.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the status of the task and a message.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">rate_limit_passed</span> <span class="ow">and</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">authorized</span> <span class="ow">and</span>
        <span class="n">rate_limit_auth_dep</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="n">UserStatusEnum</span><span class="o">.</span><span class="n">active</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">inject_rate_limit_fail_response</span><span class="p">(</span><span class="n">rate_limit_auth_dep</span><span class="p">)</span>

    <span class="c1"># check wallet address is valid EVM address</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">Web3</span><span class="o">.</span><span class="n">toChecksumAddress</span><span class="p">(</span><span class="n">task_status_request</span><span class="o">.</span><span class="n">wallet_address</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">400</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Invalid wallet address: </span><span class="si">{</span><span class="n">task_status_request</span><span class="o">.</span><span class="n">wallet_address</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">project_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">task_status_request</span><span class="o">.</span><span class="n">task_type</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">task_status_request</span><span class="o">.</span><span class="n">wallet_address</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">namespace</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">try</span><span class="p">:</span>

        <span class="c1"># check redis first, if doesn&#39;t exist, fetch from contract</span>
        <span class="n">last_finalized_epoch</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">redis_pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">project_last_finalized_epoch_key</span><span class="p">(</span><span class="n">project_id</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">last_finalized_epoch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="p">[</span><span class="n">last_finalized_epoch</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">anchor_rpc_helper</span><span class="o">.</span><span class="n">web3_call</span><span class="p">(</span>
                <span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">protocol_state_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">lastFinalizedSnapshot</span><span class="p">(</span><span class="n">project_id</span><span class="p">)],</span>
                <span class="n">redis_conn</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">redis_pool</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># cache it in redis</span>
            <span class="k">if</span> <span class="n">last_finalized_epoch</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">redis_pool</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                    <span class="n">project_last_finalized_epoch_key</span><span class="p">(</span><span class="n">project_id</span><span class="p">),</span>
                    <span class="n">last_finalized_epoch</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_finalized_epoch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">last_finalized_epoch</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">rest_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
            <span class="s1">&#39;Exception in get_current_epoch&#39;</span><span class="p">,</span>
            <span class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Unable to get last_finalized_epoch, error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="n">auth_redis_conn</span><span class="p">:</span> <span class="n">aioredis</span><span class="o">.</span><span class="n">Redis</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">auth_aioredis_pool</span>
        <span class="k">await</span> <span class="n">incr_success_calls_count</span><span class="p">(</span><span class="n">auth_redis_conn</span><span class="p">,</span> <span class="n">rate_limit_auth_dep</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">last_finalized_epoch</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;completed&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Task </span><span class="si">{</span><span class="n">task_status_request</span><span class="o">.</span><span class="n">task_type</span><span class="si">}</span><span class="s1"> for wallet </span><span class="si">{</span><span class="n">task_status_request</span><span class="o">.</span><span class="n">wallet_address</span><span class="si">}</span><span class="s1"> was completed in epoch </span><span class="si">{</span><span class="n">last_finalized_epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;completed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Task </span><span class="si">{</span><span class="n">task_status_request</span><span class="o">.</span><span class="n">task_type</span><span class="si">}</span><span class="s1"> for wallet </span><span class="si">{</span><span class="n">task_status_request</span><span class="o">.</span><span class="n">wallet_address</span><span class="si">}</span><span class="s1"> is not completed yet&#39;</span><span class="p">,</span>
            <span class="p">}</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Powerloom Inc..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

</body>
</html>
